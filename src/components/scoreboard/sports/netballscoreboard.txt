import React, { useState } from 'react';
import {
  Box,
  Grid,
  Paper,
  Typography,
  Button,
} from '@mui/material';
import { SportType } from '../../../types/types';
import { useSocket } from '../../../contexts/SocketContext';
import Timer from '../common/Timer';

interface NetballScoreboardProps {
  format: SportType;
}

const NetballScoreboard: React.FC<NetballScoreboardProps> = ({ format }) => {
  const socket = useSocket();
  const [homeScore, setHomeScore] = useState(0);
  const [awayScore, setAwayScore] = useState(0);
  const [quarter, setQuarter] = useState(1);
  const [isPlaying, setIsPlaying] = useState(false);
  const [timeRemaining, setTimeRemaining] = useState(
    format === SportType.INDOOR_NETBALL ? 10 * 60 : 15 * 60
  );

  const handleScore = (team: 'home' | 'away', points: number) => {
    if (team === 'home') {
      setHomeScore(prev => prev + points);
    } else {
      setAwayScore(prev => prev + points);
    }

    socket.emit('scoreUpdate', {
      type: 'SCORE',
      team,
      points,
      homeScore: team === 'home' ? homeScore + points : homeScore,
      awayScore: team === 'away' ? awayScore + points : awayScore,
      quarter,
      timeRemaining
    });
  };

  const handleQuarterEnd = () => {
    if (quarter < 4) {
      setQuarter(prev => prev + 1);
      setTimeRemaining(
        format === SportType.INDOOR_NETBALL ? 10 * 60 : 15 * 60
      );
      socket.emit('quarterEnd', { quarter });
    } else {
      handleGameEnd();
    }
  };

  const handleGameEnd = () => {
    setIsPlaying(false);
    socket.emit('gameEnd', {
      finalScore: {
        home: homeScore,
        away: awayScore
      }
    });
  };

  return (
    <Box>
      <Grid container spacing={2}>
        <Grid item xs={12}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h4">
              Quarter {quarter}
            </Typography>
            <Timer
              initialTime={timeRemaining}
              isPlaying={isPlaying}
              onTimeUpdate={setTimeRemaining}
              onTimeEnd={handleQuarterEnd}
            />
            <Button
              variant="contained"
              onClick={() => setIsPlaying(!isPlaying)}
              sx={{ mt: 1 }}
            >
              {isPlaying ? 'Pause' : 'Start'}
            </Button>
          </Paper>
        </Grid>

        <Grid item xs={6}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h4">Home</Typography>
            <Typography variant="h2">{homeScore}</Typography>
            <Button
              fullWidth
              variant="contained"
              onClick={() => handleScore('home', 1)}
              sx={{ mt: 2 }}
            >
              Goal (+1)
            </Button>
          </Paper>
        </Grid>

        <Grid item xs={6}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h4">Away</Typography>
            <Typography variant="h2">{awayScore}</Typography>
            <Button
              fullWidth
              variant="contained"
              onClick={() => handleScore('away', 1)}
              sx={{ mt: 2 }}
            >
              Goal (+1)
            </Button>
          </Paper>
        </Grid>
      </Grid>
    </Box>
  );
};

export default NetballScoreboard;